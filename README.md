Этот репозиторий включает в себя основной код бекенда Кочерги. В том числе HTTP API.

Весь код на Python.

# Организация разработки

## Как начать

1. Скачать код этого репозитория.
2. Получить у кого-нибудь архив с тестовыми конфигами, распаковать конфиги куда-нибудь неважно куда (можно вне репозитория).
3. Открыть config.json в папке с конфигами, поправить в нём переменные `image_storage_dir` и `kocherga_db_file`.
4. Установить pipenv и поставить зависимости c помощью `make install-dev`.
5. Активировать среду разработки с помощью `pipenv shell`.
6. Путь к конфигам можно передать через `CONFIG_DIR` (логика выбора пути к конфигам находится в `kocherga.config`).
7. Запустить pytest, убедиться, что тесты проходятся.

## Выкладка изменений

Деплой организован с помощью Ansible, конфиги в [отдельном репозитории](https://gitlab.com/kocherga/code/deploy) (роль kocherga-api).

## Типизация

Понемногу начинаем пользоваться [аннотациями типов](https://www.python.org/dev/peps/pep-0484/) и [mypy](http://mypy-lang.org/).

Заглушки для сторонних библиотек - в `stubs/local-stubs`. Если появятся хорошие внешние заглушки, то можно их подключать через git submodule в `stubs/*`, но с [sqlalchemy-stubs](https://github.com/JelleZijlstra/sqlalchemy-stubs) было много проблем, так что пока что ни одного прецедента этому нет.

Чтобы проверить типы на корректность, вызовите `make test-types`.

## Тесты

Тесты есть не на всё, но на многое. Тесты используют [pytest](https://docs.pytest.org/en/latest/).

Чтобы запустить отдельные тесты, вызовите `pytest test/test_FILENAME.py`.

# Компоненты

* HTTP API - Quart-приложение на https://api.kocherga.club, реализующее REST API
* Importer - демон для наполнения базы
* прочие модули `kocherga.*`, используемые в скриптах и других компонентах

## HTTP API

Код в `kocherga.api.*`.

Написано на фреймворке Quart (асинхронный клон Flask'а).

### Модули

* `kocherga.api.app` - главное Quart-приложение
* `kocherga.api.routes.*` - Blueprints
* `kocherga.api.common` - некоторые общие переменные и функции
* `kocherga.api.auth` - декораторы для авторизации

## Importer

Код в `kocherga.importer.*`.

Наполняет локальную базу данными из различных источников (ОФД, телефония, гуглокалендарь и т.д.)

Работает в виде демона (см. `kocherga.importer.daemon`).

## Конфиги

Модуль `kocherga.config` отвечает за загрузку конфигурации (файла config.json), а модуль `kocherga.secrets` - за загрузку более секретных ключей и паролей.

Все конфиги и секреты находятся в директории `config/`, существующей вне этого репозитория. Чтобы присоединиться к разработке или выкатить куда-нибудь этот код, вам надо будет где-то добыть эту директорию (иначе придётся собирать все поля конфига по кусочкам из разных модулей).

## База данных

За хранение большинства данных отвечает локальная sqlite-база.

Для взаимодействия с базой используем [SQLAlchemy](https://www.sqlalchemy.org/) ORM. Для миграций - [Alembic](http://alembic.zzzcomputing.com/).
