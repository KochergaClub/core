Этот репозиторий включает в себя основной код бекенда Кочерги. В том числе HTTP API.

Весь код на Python.

# Организация разработки

## Как начать

1. Скачать код этого репозитория.
2. Получить у кого-нибудь архив с тестовым конфигом секретов, положить в `kocherga.django.settings.dev_secrets`.
3. Установить docker и docker-compose.
4. Только для маков: `gem install docker-sync` (чинит проблемы с производительностью и автообновлением при правках кода).
5. Запустить `make init-dev` для создания базы и установки npm-пакетов (они перезатираются текущей директорией с кодом из-за монтирования volume).
5. Активировать среду разработки с помощью `make dev`. (Если у вас мак, то лучше использовать `make dev-mac` - в этом случае вспомогательные процессы типа webpаck'а запустятся вне контейнеров и у вас не будет проблем с перекомпиляцией по inotify).
6. Запустить `make test`, убедиться, что тесты проходятся.

## Выкладка изменений

Деплой организован с помощью GitLab CI, конфиг в файле `.gitlab-ci`.

Изначальная настройка сервера делается с помощью ansible, см. репозиторий [deploy](https://gitlab.com/kocherga/code/deploy), роль `kocherga-core`.

## Типизация

Понемногу начинаем пользоваться [аннотациями типов](https://www.python.org/dev/peps/pep-0484/) и [mypy](http://mypy-lang.org/).

Чтобы проверить типы на корректность, вызовите `make test-types`. Пока что эта проверка падает с большим количеством ошибок.

## Тесты

Тесты есть не на всё, но на многое. Тесты используют [pytest](https://docs.pytest.org/en/latest/).

Чтобы запустить отдельный тест, вызовите `./test.sh test/test_FILENAME.py`. (Для этой команды нужен работающие в фоне docker-контейнеры, которые можно поднять с помощью `make dev` в отдельной вкладке).

# Компоненты

Список django-приложений можно посмотреть в `kocherga.django.settings.base`.

Общие и вспомогательные модули:
* kocherga.django
* kocherga.dateutils
* kocherga.error

Прочее (постепенно будет переезжать в common/ или рефакториться в django-приложения):
* email
* gdrive
* google
* images
* importer
* ludwig
* mailchimp
* room
* security
* setup
* slack
* telegram
* templater
* vk
* wiki
* yandex

## api

REST API. Код в `kocherga.api.*`. Django-приложение для урлов в `/api`.

Код использует Django REST Framework, но написан довольно неоптимально (избыточно), потому что кое-как портирован со старого Flask-приложения.

## importer

Код в `kocherga.importer.*`.

Наполняет локальную базу данными из различных источников (ОФД, телефония, гуглокалендарь и т.д.)

Работает в виде демона (см. `kocherga.importer.daemon`). Отдельные импорты можно запускать через скрипт `scripts/importer.py`.

## База данных

За хранение большинства данных отвечает локальная MySQL-база.

Некоторые данные хранятся в `DATA_DIR`. В будущем перевезём их (STATIC и MEDIA) на S3.
