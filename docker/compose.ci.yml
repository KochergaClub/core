version: '3.4'

x-backend:
  &backend
  image: registry.gitlab.com/kocherga/core/backend:${TAG}
  volumes:
    - ../backend/data:/data
  environment:
    DJANGO_SETTINGS_MODULE: 'kocherga.django.settings.ci'
    DB_NAME: 'kocherga'
    DB_USER: 'root'
    DB_PASSWORD: ''
  cap_add:
    - SYS_PTRACE

x-frontend:
  &frontend
  image: registry.gitlab.com/kocherga/core/frontend:${TAG}
  volumes:
    - ../backend/data:/data
  environment:
    NODE_ENV: 'production'
  cap_add:
    - SYS_PTRACE

services:
  db:
    image: mariadb:10.3
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: 1
    volumes:
      - /data/kocherga-db:/var/lib/mysql
      - ../mysql.conf.d:/etc/mysql/conf.d

  chrome:
    image: registry.gitlab.com/kocherga/core/chrome:${TAG}
    cap_add:
      - SYS_ADMIN
    ports:
      - "127.0.0.1:9222:9222"
    privileged: true

  redis:
    image: redis:5.0
    ports:
      - "127.0.0.1:6379:6379"

  api:
    << : *backend
    command: ./manage.py runserver --noreload 0.0.0.0:80
    ports:
      - "127.0.0.1:8000:80"
    depends_on:
      - db
      - render-server
      - chrome
      - redis

  render-server:
    << : *frontend
    command: bash -c 'cd jsx && node ./render/server/index.js'
